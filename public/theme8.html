<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Royal Union • Luxury Wedding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-deep: #0b0f19;
      --bg-panel: #141a26;
      --gold: #d4af37;
      --gold-dim: #8a702a;
      --text-light: #f4f4f4;
      --text-mute: #a0a6b5;
      --border-gold: 1px solid rgba(212, 175, 55, 0.3);
      --glass: rgba(11, 15, 25, 0.85);
      --nav-height: 80px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background-color: var(--bg-deep);
      color: var(--text-light);
      font-family: 'Montserrat', sans-serif;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Grain Overlay for Texture */
    .texture-overlay {
      position: fixed; inset: 0; pointer-events: none; z-index: 1;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
    }

    h1, h2, h3 { font-family: 'Cinzel', serif; font-weight: 400; text-transform: uppercase; letter-spacing: 0.05em; }
    p, span, div { letter-spacing: 0.02em; }
    a { text-decoration: none; color: inherit; transition: 0.3s; }
    button { cursor: pointer; font-family: inherit; }

    /* === NAVIGATION === */
    .lux-nav {
      position: fixed; top: 0; left: 0; right: 0; height: var(--nav-height);
      background: rgba(11, 15, 25, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(212, 175, 55, 0.1);
      z-index: 1000;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 40px;
    }

    .nav-brand {
      display: flex; align-items: center; gap: 15px;
    }
    .nav-avatar {
      width: 45px; height: 45px; border-radius: 50%;
      border: 1px solid var(--gold);
      overflow: hidden; display: grid; place-items: center;
      background: #000; color: var(--gold); font-family: 'Cinzel', serif;
    }
    .nav-avatar img { width: 100%; height: 100%; object-fit: cover; display: none; }
    
    .nav-title {
      font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--gold);
      letter-spacing: 0.1em;
    }

    .nav-links { display: flex; gap: 30px; }
    .nav-btn {
      background: transparent; border: none; color: var(--text-mute);
      font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.15em;
      position: relative; padding: 5px 0;
    }
    .nav-btn::after {
      content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px;
      background: var(--gold); transition: 0.3s;
    }
    .nav-btn:hover, .nav-btn.active { color: var(--gold); }
    .nav-btn:hover::after, .nav-btn.active::after { width: 100%; }

    /* Mobile Hamburger */
    .hamburger { display: none; background: transparent; border: none; flex-direction: column; gap: 6px; }
    .hamburger span { width: 25px; height: 1px; background: var(--gold); }
    
    @media (max-width: 900px) {
      .nav-links { display: none; }
      .hamburger { display: flex; }
      .lux-nav { padding: 0 20px; }
    }

    /* Mobile Menu Overlay */
    .mob-menu {
      position: fixed; inset: 0; background: var(--bg-deep);
      z-index: 999; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 25px;
      transform: translateX(100%); transition: 0.4s cubic-bezier(0.77, 0, 0.175, 1);
    }
    .mob-menu.open { transform: translateX(0); }
    .mob-menu button {
      background: transparent; border: none; font-family: 'Cinzel', serif;
      font-size: 1.5rem; color: var(--text-light);
    }
    .mob-menu-close {
      position: absolute; top: 20px; right: 20px;
      font-size: 2rem; background: transparent; border: none; color: var(--gold);
    }

    /* === HERO SECTION === */
    .hero-wrap {
      height: 100vh; position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      text-align: center;
    }
    .hero-bg {
      position: absolute; inset: 0; z-index: -1;
    }
    .hero-bg img {
      width: 100%; height: 100%; object-fit: cover;
      position: absolute; inset: 0; opacity: 0; transition: opacity 2s ease;
      filter: brightness(0.4) sepia(0.2);
    }
    .hero-bg img.active {
      opacity: 1;
      animation: kenBurns 15s infinite alternate;
    }
    @keyframes kenBurns { from { transform: scale(1); } to { transform: scale(1.1); } }

    .hero-content {
      z-index: 2; position: relative;
      padding: 20px; border: 1px solid rgba(212, 175, 55, 0.3);
      background: rgba(11, 15, 25, 0.6);
      backdrop-filter: blur(4px);
      max-width: 800px; margin: 0 20px;
    }
    .hero-pre { font-size: 0.9rem; text-transform: uppercase; color: var(--gold); letter-spacing: 0.2em; margin-bottom: 10px; }
    .hero-title { font-size: 4rem; line-height: 1; color: var(--text-light); margin-bottom: 20px; }
    .hero-meta {
      display: flex; justify-content: center; gap: 20px; margin-top: 20px;
      border-top: 1px solid var(--gold-dim); padding-top: 20px;
      font-size: 0.9rem; letter-spacing: 0.1em; color: var(--text-mute);
    }
    .hero-tagline { margin-top: 15px; font-style: italic; color: var(--gold); }

    @media(max-width: 600px) { .hero-title { font-size: 2.5rem; } .hero-meta { flex-direction: column; gap: 5px; } }

    /* COUNTDOWN (Linear Gold) */
    .cd-strip {
      display: flex; justify-content: center; gap: 40px; margin-top: 30px;
    }
    .cd-item { text-align: center; }
    .cd-num { font-family: 'Cinzel', serif; font-size: 2rem; color: var(--gold); display: block; line-height: 1; }
    .cd-lbl { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.2em; color: var(--text-mute); }
    @media(max-width: 500px) { .cd-strip { gap: 15px; } .cd-num { font-size: 1.4rem; } }

    /* === SECTIONS === */
    .page-container {
      max-width: 1000px; margin: 0 auto;
      padding: 80px 20px; position: relative; z-index: 2;
    }
    
    .section-title {
      text-align: center; margin-bottom: 60px; position: relative;
    }
    .section-title h2 { font-size: 2.5rem; color: var(--gold); }
    .section-title::after {
      content: "♦"; display: block; color: var(--gold-dim); font-size: 1.5rem; margin-top: 10px;
    }

    .lux-card {
      background: var(--bg-panel); border: var(--border-gold);
      padding: 40px; margin-bottom: 30px; position: relative;
      transition: 0.3s;
    }
    .lux-card:hover { border-color: var(--gold); box-shadow: 0 0 20px rgba(212, 175, 55, 0.1); }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    @media(max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }

    .info-label { color: var(--gold); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 5px; }
    .info-val { font-size: 1.2rem; font-family: 'Cinzel', serif; color: var(--text-light); margin-bottom: 10px; }
    .info-text { font-size: 0.95rem; color: var(--text-mute); line-height: 1.6; }

    /* Buttons */
    .btn-gold {
      display: inline-block; padding: 12px 30px;
      border: 1px solid var(--gold); background: transparent;
      color: var(--gold); text-transform: uppercase; letter-spacing: 0.15em; font-size: 0.8rem;
      transition: 0.4s; margin-top: 15px; text-align: center;
    }
    .btn-gold:hover { background: var(--gold); color: #000; }
    
    /* ENTOURAGE (Clean List) */
    .entourage-group { margin-bottom: 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 20px; }
    .entourage-role { color: var(--gold); font-family: 'Cinzel', serif; margin-bottom: 8px; font-size: 1.1rem; }
    .entourage-names { color: var(--text-mute); font-size: 0.95rem; white-space: pre-line; }

    /* STORY (Center Line) */
    .story-block { text-align: center; max-width: 700px; margin: 0 auto 40px; }
    .story-text { line-height: 1.8; color: var(--text-mute); }
    .verse-box {
      border: 1px solid var(--gold-dim); padding: 30px; text-align: center; margin-top: 40px;
    }
    .verse-ref { color: var(--gold); margin-bottom: 10px; font-weight: bold; }
    .verse-txt { font-style: italic; font-family: 'Cinzel', serif; }

    /* GALLERY */
    .gallery-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;
    }
    .gallery-img {
      width: 100%; aspect-ratio: 1; object-fit: cover;
      filter: grayscale(100%); transition: 0.5s; cursor: pointer;
      border: 1px solid transparent;
    }
    .gallery-img:hover { filter: grayscale(0%); border-color: var(--gold); transform: scale(1.02); }

    /* RSVP FORM */
    .form-group { margin-bottom: 20px; }
    .lux-input {
      width: 100%; background: transparent; border: none;
      border-bottom: 1px solid var(--text-mute);
      padding: 15px 0; color: var(--text-light); font-family: inherit; font-size: 1rem;
      transition: 0.3s;
    }
    .lux-input:focus { outline: none; border-bottom-color: var(--gold); }
    .lux-select {
      width: 100%; background: var(--bg-panel); border: 1px solid var(--text-mute);
      padding: 15px; color: var(--text-light); margin-top: 10px;
    }

    /* Video */
    .video-container {
      position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
      border: 1px solid var(--gold-dim);
    }
    .video-container iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }

    /* Reveal Animation */
    .reveal { opacity: 0; transform: translateY(30px); transition: 1s ease; }
    .reveal.active { opacity: 1; transform: translateY(0); }

    /* Footer */
    footer {
      text-align: center; padding: 40px; border-top: 1px solid rgba(212, 175, 55, 0.2);
      color: var(--text-mute); font-size: 0.8rem;
    }
    
    /* Dress Code Swatches */
    .swatch-row { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
    .swatch { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--gold); }

    /* Maps & Photos in Details */
    .loc-photo img { width: 100%; aspect-ratio: 21/9; object-fit: cover; border-bottom: 1px solid var(--gold); margin-bottom: 20px; opacity: 0.8; }
  </style>
</head>
<body>

  <div class="texture-overlay"></div>

  <nav class="lux-nav">
    <div class="nav-brand">
      <div class="nav-avatar">
        <img id="nav-hero-pic" alt="Couple" />
        <span id="nav-initials"></span>
      </div>
      <div class="nav-title" id="nav-couple">The Wedding</div>
    </div>
    
    <div class="nav-links">
      <button class="nav-btn" data-target="home">Welcome</button>
      <button class="nav-btn" data-target="details">The Event</button>
      <button class="nav-btn" data-target="entourage">People</button>
      <button class="nav-btn" data-target="story">Story</button>
      <button class="nav-btn" data-target="media">Gallery</button>
      <button class="nav-btn" data-target="rsvp" style="color:var(--gold)">RSVP</button>
    </div>

    <button class="hamburger" id="hamburger">
      <span></span><span></span><span></span>
    </button>
  </nav>

  <div class="mob-menu" id="mob-menu">
    <button class="mob-menu-close" id="mob-close">&times;</button>
    <button data-target="home">Welcome</button>
    <button data-target="details">The Event</button>
    <button data-target="entourage">People</button>
    <button data-target="story">Story</button>
    <button data-target="media">Gallery</button>
    <button data-target="rsvp" style="color:var(--gold)">RSVP</button>
  </div>

  <section id="home" class="hero-wrap">
    <div class="hero-bg">
      <img id="hero-photo-a" class="active" alt="Background A">
      <img id="hero-photo-b" alt="Background B">
    </div>

    <div class="hero-content reveal">
      <div class="hero-pre">We Invite You To Celebrate</div>
      <div class="hero-title" id="hero-names">Name & Name</div>
      <div class="hero-tagline" id="hero-tagline"></div>
      
      <div class="hero-meta">
        <span id="hero-date">Date</span>
        <span>&bull;</span>
        <span id="hero-venue">Venue</span>
        <span>&bull;</span>
        <span id="hero-time">Time</span>
      </div>

      <div id="countdown" class="cd-strip">
        <div class="cd-item"><span class="cd-num" id="cd-days">00</span><span class="cd-lbl">Days</span></div>
        <div class="cd-item"><span class="cd-num" id="cd-hours">00</span><span class="cd-lbl">Hours</span></div>
        <div class="cd-item"><span class="cd-num" id="cd-mins">00</span><span class="cd-lbl">Mins</span></div>
        <div class="cd-item"><span class="cd-num" id="cd-secs">00</span><span class="cd-lbl">Secs</span></div>
      </div>
      
      <div style="margin-top: 40px;">
        <button class="btn-gold" style="background: var(--gold); color: #000;" data-jump="rsvp">RSVP Now</button>
      </div>
    </div>
  </section>

  <div class="page-container">
    
    <section id="details" class="reveal">
      <div class="section-title">
        <h2>The Grand Celebration</h2>
        <div style="color: var(--text-mute); margin-top: 10px;">
          <span id="details-date"></span> &mdash; <span id="details-time"></span>
        </div>
      </div>

      <div class="grid-2">
        <div class="lux-card">
          <div class="loc-photo" id="ceremony-photo-wrap"></div>
          <div class="info-label">Ceremony</div>
          <div class="info-val" id="ceremony-name"></div>
          <div class="info-text" id="ceremony-address"></div>
          <div class="info-text" style="font-style:italic; margin-top:10px;" id="ceremony-notes"></div>
          <a id="ceremony-map" target="_blank" class="btn-gold" style="display:none;">View Map</a>
        </div>

        <div class="lux-card">
          <div class="loc-photo" id="reception-photo-wrap"></div>
          <div class="info-label">Reception</div>
          <div class="info-val" id="reception-name"></div>
          <div class="info-text" id="reception-address"></div>
          <div class="info-text" style="font-style:italic; margin-top:10px;" id="reception-notes"></div>
          <a id="reception-map" target="_blank" class="btn-gold" style="display:none;">View Map</a>
        </div>
      </div>

      <div class="lux-card" style="text-align: center;">
        <div class="info-label">Dress Code</div>
        <div class="info-val" id="dress-title">Formal</div>
        <div class="info-text" id="dress-desc"></div>
        <div class="swatch-row" id="dress-colors"></div>
      </div>
    </section>

    <section id="entourage" class="reveal">
      <div class="section-title">
        <h2>The Entourage</h2>
      </div>
      
      <div class="lux-card">
        <div class="grid-2">
          <div class="entourage-group">
            <div class="entourage-role">Parents of the Bride</div>
            <div class="entourage-names" id="parents-bride"></div>
          </div>
          <div class="entourage-group">
            <div class="entourage-role">Parents of the Groom</div>
            <div class="entourage-names" id="parents-groom"></div>
          </div>
        </div>
        
        <div class="entourage-group">
          <div class="entourage-role">Principal Sponsors</div>
          <div class="entourage-names" id="principal-sponsors"></div>
        </div>

        <div class="grid-2">
          <div class="entourage-group">
            <div class="entourage-role">Maid of Honor</div>
            <div class="entourage-names" id="maid-of-honor"></div>
          </div>
          <div class="entourage-group">
            <div class="entourage-role">Best Man</div>
            <div class="entourage-names" id="best-man"></div>
          </div>
        </div>

        <div class="entourage-group">
          <div class="entourage-role">Secondary Sponsors</div>
          <div class="entourage-names" id="secondary-sponsors"></div>
        </div>

        <div class="grid-2">
          <div class="entourage-group">
            <div class="entourage-role">Flower Girls</div>
            <div class="entourage-names" id="flower-girls"></div>
          </div>
          <div class="entourage-group">
            <div class="entourage-role">Ring Bearer</div>
            <div class="entourage-names" id="ring-bearer"></div>
          </div>
        </div>
        
        <div class="entourage-group" style="border:none;">
          <div class="entourage-role">Other Roles</div>
          <div class="entourage-names" id="other-roles"></div>
        </div>
      </div>
    </section>

    <section id="story" class="reveal">
      <div class="section-title"><h2>Our Story</h2></div>
      
      <div class="story-block">
        <div class="info-label">How We Met</div>
        <p class="story-text" id="our-story"></p>
      </div>

      <div class="story-block">
        <div class="info-label">The Proposal</div>
        <p class="story-text" id="proposal-story"></p>
      </div>

      <div class="verse-box">
        <div class="verse-ref" id="verse-ref"></div>
        <div class="verse-txt" id="verse-text"></div>
      </div>
    </section>

    <section id="media" class="reveal">
      <div class="section-title"><h2>Gallery</h2></div>
      
      <div class="gallery-grid" id="gallery"></div>
      
      <div id="video-wrap" class="lux-card" style="margin-top: 40px; display: none;">
        <div class="info-label" style="text-align:center; margin-bottom:15px;">Official Video</div>
        <div class="video-container">
          <iframe id="video-iframe" allowfullscreen></iframe>
        </div>
      </div>
    </section>

    <section id="rsvp" class="reveal">
      <div class="section-title"><h2>RSVP</h2></div>
      
      <div class="lux-card" style="max-width: 600px; margin: 0 auto;">
        <div style="text-align:center; margin-bottom: 20px;">
          <div class="info-val">Kindly Respond</div>
          <div class="info-text" id="rsvp-note"></div>
          <div class="info-label" style="margin-top:10px; color: var(--gold);" id="rsvp-deadline"></div>
        </div>

        <input type="text" id="rsvp-name" class="lux-input" placeholder="Your Full Name">
        
        <select id="rsvp-status" class="lux-select">
          <option value="attending">Joyfully Accept</option>
          <option value="not_attending">Regretfully Decline</option>
          <option value="maybe">Uncertain</option>
        </select>
        
        <input type="text" id="rsvp-message" class="lux-input" placeholder="Message for the couple (Optional)">
        
        <button id="btn-submit-rsvp" class="btn-gold" style="width:100%;">Confirm Attendance</button>
      </div>
      
      <footer>
        <div id="invite-id-mini" style="margin-bottom: 5px;"><span style="opacity:0.5;">Invite ID: Loading...</span></div>
        <div id="attendees-text" style="color: var(--gold);">0 Attending</div>
      </footer>
    </section>

  </div>

  <script>
    const SUPABASE_URL = "https://minftvflekxdoiubeujy.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pbmZ0dmZsZWt4ZG9pdWJldWp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1MTc4NjgsImV4cCI6MjA2NjA5Mzg2OH0.Aj0-ts6WzffJRrXDkTMDKjQT4t6pW_-jSUft4md0KJM";

    const INVITES_TABLE = "invites-new";
    const RSVPS_TABLE = "rsvps";

    let supabaseClient = null;
    let inviteId = null;
    let inviteData = null;

    let heroSlides = [];
    let heroIndex = 0;
    let heroInterval = null;
    let heroActive = "a";
    let countdownTimer = null;

    function scrollToSection(id){
      const el = document.getElementById(id);
      if(!el) return;
      // Offset for sticky nav
      const y = el.getBoundingClientRect().top + window.pageYOffset - 90;
      window.scrollTo({top: y, behavior: 'smooth'});
      document.getElementById("mob-menu")?.classList.remove("open");
    }

    function setupMenu(){
      document.querySelectorAll("[data-target]").forEach(btn=>{
        btn.addEventListener("click", () => scrollToSection(btn.dataset.target));
      });
      document.querySelectorAll("[data-jump]").forEach(btn=>{
        btn.addEventListener("click", () => scrollToSection(btn.dataset.jump));
      });
      const ham = document.getElementById("hamburger");
      const close = document.getElementById("mob-close");
      const menu = document.getElementById("mob-menu");
      ham?.addEventListener("click", ()=> menu.classList.add("open"));
      close?.addEventListener("click", ()=> menu.classList.remove("open"));
    }

    function fmtDate(d){
      if(!d) return "";
      try{
        return new Date(d).toLocaleDateString(undefined, {
          year:"numeric", month:"long", day:"numeric"
        });
      }catch(e){ return d; }
    }

    function fmtTime(t){
      if(!t) return "";
      try{
        const [hh, mm] = String(t).split(":");
        const d = new Date();
        d.setHours(+hh||0, +mm||0, 0);
        return d.toLocaleTimeString([], {hour:"numeric", minute:"2-digit"});
      }catch(e){ return t; }
    }

    function normalizeYouTubeUrl(url){
      if(!url) return "";
      try{
        const u = new URL(url);
        const host = u.hostname.replace("www.","");
        if(host.includes("youtube.com") || host === "youtu.be"){
          let id = "";
          if(host === "youtu.be") id = u.pathname.slice(1);
          else if(u.pathname.startsWith("/embed/")) id = u.pathname.split("/embed/")[1];
          else if(u.pathname.startsWith("/shorts/")) id = u.pathname.split("/shorts/")[1];
          else if(u.searchParams.get("v")) id = u.searchParams.get("v");
          if(id){
            id = id.split("?")[0].split("&")[0].split("/")[0];
            return `https://www.youtube.com/embed/${id}`;
          }
        }
        return url;
      }catch(e){ return url; }
    }

    function renderNavAvatar(photos, bride, groom){
      const navPic = document.getElementById("nav-hero-pic");
      const initialsEl = document.getElementById("nav-initials");
      const initials = `${(bride||"B")[0]}${(groom||"G")[0]}`.toUpperCase();
      if(photos?.[0]){
        navPic.src = photos[0];
        navPic.style.display = "block";
        initialsEl.style.display = "none";
      }else{
        navPic.style.display = "none";
        initialsEl.style.display = "block";
        initialsEl.textContent = initials;
      }
    }

    function startHeroSlideshow(photos){
      if(heroInterval) clearInterval(heroInterval);
      heroSlides = (photos || []).filter(Boolean);

      const imgA = document.getElementById("hero-photo-a");
      const imgB = document.getElementById("hero-photo-b");
      if(!imgA || !imgB) return;

      if(heroSlides.length === 0){
        imgA.style.display = "none";
        imgB.style.display = "none";
        return;
      }

      imgA.style.display = "block";
      imgB.style.display = "block";

      heroIndex = 0;
      heroActive = "a";

      imgA.src = heroSlides[0];
      imgA.classList.add("active");
      imgB.classList.remove("active");

      if(heroSlides.length === 1) return;

      heroInterval = setInterval(()=>{
        const nextIndex = (heroIndex + 1) % heroSlides.length;
        const nextUrl = heroSlides[nextIndex];
        const nextImg = heroActive === "a" ? imgB : imgA;
        const curImg  = heroActive === "a" ? imgA : imgB;

        nextImg.src = nextUrl;
        nextImg.classList.add("active");
        curImg.classList.remove("active");

        heroActive = heroActive === "a" ? "b" : "a";
        heroIndex = nextIndex;
      }, 5000); // Slower for cinematic feel
    }

    function startCountdown(dateStr, timeStr){
      if(countdownTimer) clearInterval(countdownTimer);
      const dEl = document.getElementById("cd-days");
      const hEl = document.getElementById("cd-hours");
      const mEl = document.getElementById("cd-mins");
      const sEl = document.getElementById("cd-secs");
      if(!dateStr) return;

      function tick(){
        const target = new Date(dateStr);
        if(timeStr){
          const [hh, mm] = String(timeStr).split(":");
          target.setHours(+hh||0, +mm||0, 0, 0);
        }
        const now = new Date();
        let diffMs = target - now;
        if(isNaN(diffMs)) return;
        if(diffMs < 0) diffMs = 0;

        const totalSec = Math.floor(diffMs / 1000);
        const days  = Math.floor(totalSec / 86400);
        const hours = Math.floor((totalSec % 86400) / 3600);
        const mins  = Math.floor((totalSec % 3600) / 60);
        const secs  = totalSec % 60;

        dEl.textContent = days.toString().padStart(2, '0');
        hEl.textContent = hours.toString().padStart(2, '0');
        mEl.textContent = mins.toString().padStart(2, '0');
        sEl.textContent = secs.toString().padStart(2, '0');
      }

      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    function renderInvite(){
      const bride = inviteData.bride || "Bride";
      const groom = inviteData.groom || "Groom";
      const tagline = inviteData.tagline || "";

      document.getElementById("nav-couple").textContent = `${bride} & ${groom}`;
      document.getElementById("hero-names").textContent = `${bride} & ${groom}`;
      document.getElementById("hero-tagline").textContent = tagline;

      const dateRaw = inviteData.wedding_date || inviteData.date;
      const timeRaw = inviteData.wedding_time || inviteData.time;
      const dateStr = fmtDate(dateRaw);
      const timeStr = fmtTime(timeRaw);
      const mainVenue = inviteData.main_venue_label || "";

      document.getElementById("hero-date").textContent = dateStr || "Date TBA";
      document.getElementById("hero-time").textContent = timeStr || "Time TBA";
      document.getElementById("hero-venue").textContent = mainVenue || "Venue TBA";

      document.getElementById("details-date").textContent = dateStr || "Date TBA";
      document.getElementById("details-time").textContent = timeStr || "Time TBA";

      document.getElementById("ceremony-name").textContent = inviteData.ceremony_name || "—";
      document.getElementById("ceremony-address").textContent = inviteData.ceremony_address || "—";
      document.getElementById("ceremony-notes").textContent = inviteData.ceremony_notes || "";

      const cMap = inviteData.ceremony_map_url || "";
      const cMapEl = document.getElementById("ceremony-map");
      cMapEl.style.display = cMap ? "inline-block" : "none";
      if(cMap) cMapEl.href = cMap;

      const cPhoto = inviteData.ceremony_photo_url || "";
      document.getElementById("ceremony-photo-wrap").innerHTML = cPhoto
        ? `<img src="${cPhoto}" />`
        : "";

      document.getElementById("reception-name").textContent = inviteData.reception_name || "—";
      document.getElementById("reception-address").textContent = inviteData.reception_address || "—";
      document.getElementById("reception-notes").textContent = inviteData.reception_notes || "";

      const rMap = inviteData.reception_map_url || "";
      const rMapEl = document.getElementById("reception-map");
      rMapEl.style.display = rMap ? "inline-block" : "none";
      if(rMap) rMapEl.href = rMap;

      const rPhoto = inviteData.reception_photo_url || "";
      document.getElementById("reception-photo-wrap").innerHTML = rPhoto
        ? `<img src="${rPhoto}" />`
        : "";

      document.getElementById("dress-title").textContent = inviteData.dress_title || "";
      document.getElementById("dress-desc").textContent = inviteData.dress_description || "";
      const colors = [inviteData.dress_color1, inviteData.dress_color2, inviteData.dress_color3].filter(Boolean);
      document.getElementById("dress-colors").innerHTML = colors.map(c => `
        <div class="swatch" style="background:${c};" title="${c}"></div>
      `).join("");

      document.getElementById("principal-sponsors").textContent = inviteData.principal_sponsors || "";
      document.getElementById("secondary-sponsors").textContent = inviteData.secondary_sponsors || "";
      document.getElementById("parents-bride").textContent = inviteData.parents_bride || "";
      document.getElementById("parents-groom").textContent = inviteData.parents_groom || "";
      document.getElementById("maid-of-honor").textContent = inviteData.maid_of_honor_block || "";
      document.getElementById("best-man").textContent = inviteData.best_man_block || "";
      document.getElementById("flower-girls").textContent = inviteData.flower_girls || "";
      document.getElementById("ring-bearer").textContent = inviteData.ring_bearer || "";
      document.getElementById("other-roles").textContent = inviteData.other_roles || "";

      document.getElementById("our-story").textContent = inviteData.our_story || "";
      document.getElementById("proposal-story").textContent = inviteData.proposal_story || "";
      document.getElementById("verse-ref").textContent = inviteData.verse_reference || "";
      document.getElementById("verse-text").textContent = inviteData.verse_text || "";

      const photos = Array.isArray(inviteData.media_photos) ? inviteData.media_photos : [];
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = photos.map((url,i)=>`
        <img src="${url}" class="gallery-img" alt="Photo ${i+1}" data-full="${url}" />
      `).join("");

      renderNavAvatar(photos, bride, groom);
      startHeroSlideshow(photos);

      gallery.querySelectorAll("img").forEach(img=>{
        img.addEventListener("click", ()=>{
          Swal.fire({
            imageUrl: img.dataset.full,
            showConfirmButton:false,
            background:"#141a26",
            color:"#d4af37",
            padding: "10px",
            imageCss: "border: 1px solid #d4af37;"
          });
        });
      });

      const vRaw = inviteData.media_video_url || "";
      const v = normalizeYouTubeUrl(vRaw);
      const vWrap = document.getElementById("video-wrap");
      const iframe = document.getElementById("video-iframe");
      vWrap.style.display = v ? "block" : "none";
      if(v) iframe.src = v;

      document.getElementById("rsvp-note").textContent =
        inviteData.rsvp_note || "Please confirm your attendance.";
      const dl = inviteData.rsvp_deadline;
      document.getElementById("rsvp-deadline").textContent =
        dl ? `Response required by ${fmtDate(dl)}` : "";

      const idMini = document.getElementById("invite-id-mini");
      const idSpan = idMini?.querySelector("span");
      if(idSpan) idSpan.textContent = `Invite ID: ${inviteId || "—"}`;

      startCountdown(dateRaw, timeRaw);
    }

    async function loadAttendeesCount(){
      if(!inviteId) return;
      const { count, error } = await supabaseClient
        .from(RSVPS_TABLE)
        .select("id", { count: "exact", head: true })
        .eq("invite_id", inviteId)
        .eq("status", "attending");

      if(error){ console.warn(error); return; }
      document.getElementById("attendees-text").textContent = `${count || 0} Guests Attending`;
    }

    async function loadInvite(){
      const params = new URLSearchParams(location.search);
      inviteId = params.get("id");
      if(!inviteId){
        Swal.fire({ 
          icon:"info", 
          title:"No invite ID", 
          text:"Open using ?id=YOUR_INVITE_ID",
          background: "#141a26",
          color: "#fff"
        });
        return;
      }

      const { data, error } = await supabaseClient
        .from(INVITES_TABLE)
        .select("*")
        .eq("id", inviteId)
        .maybeSingle();

      if(error || !data){
        Swal.fire({ icon:"error", title:"Invite not found", text:"Check link or ID.", background: "#141a26", color: "#fff" });
        return;
      }

      inviteData = data;
      renderInvite();
      loadAttendeesCount();
    }

    async function submitRSVP(){
      const name = document.getElementById("rsvp-name").value.trim();
      const status = document.getElementById("rsvp-status").value;
      const message = document.getElementById("rsvp-message").value.trim();

      if(!name){
        Swal.fire({ icon:"info", title:"Please enter your name.", background: "#141a26", color: "#fff" });
        return;
      }

      const { error } = await supabaseClient
        .from(RSVPS_TABLE)
        .insert({ invite_id: inviteId, name, status, message });

      if(error){
        console.error(error);
        Swal.fire({ icon:"error", title:"RSVP failed", text:"Please try again.", background: "#141a26", color: "#fff" });
        return;
      }

      Swal.fire({ icon:"success", title:"Thank you!", text:"Your response has been noted.", background: "#141a26", color: "#d4af37" });
      document.getElementById("rsvp-name").value = "";
      document.getElementById("rsvp-message").value = "";

      loadAttendeesCount();
    }

    function setupReveal(){
      const els = document.querySelectorAll(".reveal");
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting) e.target.classList.add("active");
        });
      }, { threshold:0.1 });
      els.forEach(el=>io.observe(el));
    }

    function setupActiveNav(){
      const sections = ["home","details","entourage","story","media","rsvp"]
        .map(id => document.getElementById(id));
      const navBtns = document.querySelectorAll(".nav-btn");
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            const id = entry.target.id;
            navBtns.forEach(b=>{
              b.classList.toggle("active", b.dataset.target === id);
            });
          }
        });
      }, { threshold:0.3 });
      sections.forEach(s=> s && io.observe(s));
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      setupMenu();
      setupReveal();
      setupActiveNav();
      await loadInvite();
      document.getElementById("btn-submit-rsvp")?.addEventListener("click", submitRSVP);
    });
  </script>
</body>
</html>