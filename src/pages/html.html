<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Worship Scheduler</title>
  <!-- Supabase JS UMD build -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#1f2937; /* gray-800 */
      --text:#e5e7eb; /* gray-200 */
      --text-dim:#9ca3af; /* gray-400 */
      --primary:#22c55e; /* green-500 */
      --primary-2:#16a34a;
      --danger:#ef4444;
      --warn:#f59e0b;
      --card:#0b1220;
      --accent:#38bdf8; /* sky-400 */
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a 20%);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.8);backdrop-filter: blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    .sub{color:var(--text-dim);font-size:12px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab-btn{padding:10px 14px;border:1px solid #1f2937;background:#0b1220;border-radius:12px;color:var(--text-dim);cursor:pointer}
    .tab-btn.active{color:#fff;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
    main{max-width:1100px;margin:18px auto;padding:0 16px}

    .grid{display:grid;gap:16px}
    @media (min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;box-shadow:0 5px 20px rgba(0,0,0,.25)}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .card .body{padding:16px}

    label{display:block;margin:8px 0 6px 0;color:var(--text-dim);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    input, select, textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #253048;background:#0a1426;color:#e5e7eb;outline:none}
    textarea{min-height:90px}
    input:focus, select:focus, textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(56,189,248,.25)}
    .row{display:flex;gap:10px}
    .row > *{flex:1}

    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #263044;background:#0e162a;color:#e5e7eb;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#14532d;color:#04130a;font-weight:600}
    .btn.subtle{background:#0b1220;border-color:#1f2937;color:#cbd5e1}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706);border-color:#92400e}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#7f1d1d}
    .btn.ghost{background:transparent;border-color:#1f2937}
    .btn.sm{padding:6px 10px;border-radius:10px;font-size:12px}

    .list{border:1px solid #1f2937;border-radius:12px;overflow:hidden}
    .list-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #162036}
    .list-item:last-child{border-bottom:none}
    .muted{color:var(--text-dim)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0e1a30;border:1px solid #1f2937;color:#9bd3ff;font-size:12px}

    .dual{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .scroll{max-height:280px;overflow:auto;border:1px solid #1f2937;border-radius:12px}
    .item{padding:10px;border-bottom:1px solid #162036;display:flex;align-items:center;justify-content:space-between}
    .item:last-child{border-bottom:none}

    .footer-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

    .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #1f2937;background:#0a1426;color:#93c5fd}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px;padding:2px 6px;border-radius:6px;background:#0c1628;border:1px solid #1f2937;color:#a3e635}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .spacer{flex:1}

    .empty{padding:14px;color:#94a3b8}
    .error{color:#fecaca}
    .success{color:#bbf7d0}

    /* New style for Sunday container */
    .sunday-container {
      margin-bottom: 20px; /* Space between Sundays */
      border: 1px solid #1f2937; /* Add a border for better separation */
      border-radius: 12px;
      overflow: hidden; /* Contains inner borders */
    }
    .sunday-container:last-child {
      margin-bottom: 0;
    }
    .sunday-header {
      font-size: 18px;
      font-weight: 600;
      padding: 12px 16px;
      background: #111827; /* Gray-900 for header */
      border-bottom: 1px solid #1f2937;
      color: var(--text);
    }
    .service-row {
      display: flex;
      align-items: center; /* Vertically center content in the row */
      justify-content: space-between;
      padding: 10px 14px;
      border-top: 1px solid var(--card); /* subtle separator */
      background: var(--card);
    }
    /* Leader avatar for leader list tab */
    .list-item .leader-avatar {
      width:32px;
      height:32px;
      border-radius:999px;
      object-fit:cover;
      border:1px solid #1f2937;
      margin-right:8px;
    }

    /* Leader avatar for schedules list tab */
    .service-row .leader-avatar {
      width:24px; /* Smaller size for schedule list */
      height:24px;
      border-radius:999px;
      object-fit:cover;
      border:1px solid #1f2937;
      margin-right:8px; /* Space between avatar and name */
      /* No need for vertical-align: middle or display: inline-block here due to flexbox */
    }

    .service-row + .service-row { /* Apply top border to subsequent service rows */
        border-top: 1px solid #162036;
    }
    .service-row.no-schedule {
      opacity: 0.8;
      font-style: italic;
    }
    .service-details {
      display: flex;
      flex-direction: column; /* Stack name/avatar, then pill, then songs, then notes */
      gap: 4px; /* Space between lines of info */
    }
    .service-details .leader-info {
      display: inline-flex; /* Use inline-flex to group avatar and name horizontally */
      align-items: center; /* Vertically center avatar and text within this group */
      font-weight: 600; /* Ensure leader name is bold */
    }
    .service-details .pill-wrapper {
        display: inline-block; /* Keep pill inline with name/avatar if possible, or on next line */
        margin-left: 8px; /* Small space after leader name if on same line */
    }
    /* Adjust pill to align with content when there's leader info */
    .service-details .pill {
        vertical-align: middle;
    }
    .service-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Worship Scheduler</h1>
      <div class="sub">Plan Sunday services (Morning & Evening), assign song leaders, and build lineups.</div>
      <nav>
        <button class="tab-btn active" data-tab="schedules">Schedules</button>
        <button class="tab-btn" data-tab="new">Create Schedule</button>
        <button class="tab-btn" data-tab="leaders">Song Leaders</button>
        <button class="tab-btn" data-tab="songs">Songs</button>
        <button class="tab-btn" data-tab="settings">Backup / Settings</button>
        <span class="spacer"></span>
        <button class="tab-btn" id="todayBtn" title="Jump to today">Today</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- SCHEDULES TAB -->
    <section id="tab-schedules">
      <div class="card">
        <div class="body">
          <div class="toolbar">
            <div class="row" style="gap:10px;flex:1">
              <div style="flex:0 0 220px">
                <label>Filter month</label>
                <input type="month" id="monthFilter" />
              </div>
              <div style="flex:0 0 220px">
                <label>Service</label>
                <select id="serviceFilter">
                  <option value="">All</option>
                  <option>Morning</option>
                  <option>Evening</option>
                </select>
              </div>
              <div style="flex:0 0 260px">
                <label>Leader</label>
                <select id="leaderFilter"></select>
              </div>
            </div>
            <span class="spacer"></span>
          </div>
          <div id="scheduleList">
            <div class="empty">Loading schedules...</div>
          </div>
        </div>
      </div>
    </section>

    <!-- CREATE TAB -->
    <section id="tab-new" hidden>
      <div class="grid grid-2">
        <div class="card">
          <div class="body">
            <h3>Details</h3>
            <div class="row">
              <div>
                <label>Date</label>
                <input type="date" id="schDate" />
              </div>
              <div>
                <label>Service</label>
                <select id="schService">
                  <option>Morning</option>
                  <option>Evening</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Song Leader</label>
                <select id="schLeader"></select>
              </div>
              <div>
                <label>Notes (optional)</label>
                <input id="schNotes" placeholder="Theme, scripture, reminders‚Ä¶" />
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="body">
            <h3>Build Lineup</h3>
            <div class="row" style="align-items:flex-end">
              <div style="flex:1">
                <label>Search songs</label>
                <input id="songSearch" placeholder="Type to filter‚Ä¶ (e.g., Way Maker)" />
              </div>
              <button class="btn subtle sm" onclick="clearLineup()">Clear Lineup</button>
            </div>

            <div class="dual" style="margin-top:10px">
              <div>
                <div class="scroll" id="songCatalog"></div>
              </div>
              <div>
                <div class="scroll" id="lineup"></div>
                <div class="footer-actions">
                  <span class="muted">Tip: use <span class="kbd">‚ñ≤/‚ñº</span> to reorder when focused</span>
                </div>
              </div>
            </div>

            <div class="footer-actions">
              <button class="btn ghost" onclick="goTab('songs')">+ Add songs</button>
              <span class="spacer"></span>
              <button class="btn primary" id="saveScheduleBtn">Save Schedule</button>
            </div>
            <div id="saveMsg" class="muted" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- LEADERS TAB -->
    <section id="tab-leaders" hidden>
      <div class="grid grid-2">
        <div class="card">
          <div class="body">
            <h3>Add / Edit Leader</h3>
            <label>Profile Photo (optional)</label>
            <input id="leaderPhoto" type="file" accept="image/*" />
            <div style="margin-top:8px; display:flex; align-items:center; gap:10px">
            <img id="leaderPreview" alt="preview" style="width:48px;height:48px;border-radius:999px;border:1px solid #1f2937;object-fit:cover;display:none" />
            <button class="btn sm subtle" type="button" onclick="clearLeaderPhoto()">Remove</button>
            </div>

            <label>Name</label>
            <input id="leaderName" placeholder="e.g., Ana D." />
            <div class="footer-actions">
              <button class="btn primary" onclick="saveLeader()">Save Leader</button>
              <button class="btn subtle" onclick="resetLeaderForm()">Reset</button>
            </div>
            <div id="leaderFormMsg" class="muted" style="margin-top:6px"></div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <h3>Leaders</h3>
            <div class="list" id="leaderList"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- SONGS TAB -->
    <section id="tab-songs" hidden>
      <div class="grid grid-2">
        <div class="card">
          <div class="body">
            <h3>Add / Edit Song</h3>
            <label>Title</label>
            <input id="songTitle" placeholder="e.g., Way Maker" />
            <div class="row">
              <div>
                <label>Key (optional)</label>
                <input id="songKey" placeholder="e.g., G" />
              </div>
              <div>
                <label>Notes (optional)</label>
                <input id="songNotes" placeholder="tempo, version, etc." />
              </div>
            </div>
            <div class="footer-actions">
              <button class="btn primary" onclick="saveSong()">Save Song</button>
              <button class="btn subtle" onclick="resetSongForm()">Reset</button>
            </div>
            <div id="songFormMsg" class="muted" style="margin-top:6px"></div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <h3>Song Catalog</h3>
            <div class="toolbar">
              <input id="songSearch2" placeholder="Search‚Ä¶" oninput="renderSongCatalog()" />
              <span class="spacer"></span>
              <button class="btn ghost" onclick="seedDemoSongs()">Seed 10 demo songs</button>
            </div>
            <div class="list" id="songList"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS / BACKUP TAB -->
    <section id="tab-settings" hidden>
      <div class="grid grid-2">
        <div class="card">
          <div class="body">
            <h3>Backup & Restore</h3>
            <div class="toolbar">
              <button class="btn" onclick="downloadBackup()">Download Backup (.json)</button>
              <label class="btn ghost" style="cursor:pointer">
                Restore from file
                <input type="file" id="restoreFile" accept="application/json" style="display:none" />
              </label>
              <button class="btn warn" onclick="if(confirm('Clear ALL data?')){clearAll()} ">Clear All</button>
            </div>
            <div class="muted">Data is stored locally in your browser via <span class="tag">localStorage</span>. This backup is for your browser's local storage data, not Supabase data.</div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <h3>Rules</h3>
            <ul class="muted">
              <li>Only one schedule per <b>date + service</b> (Morning/Evening).</li>
              <li>Lineup order is preserved as shown in the right list.</li>
              <li>You can edit or duplicate a schedule anytime.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
  </main>

  <template id="tplSongRow">
    <div class="item">
      <div>
        <div class="title"></div>
        <div class="muted meta" style="font-size:12px"></div>
      </div>
      <div>
        <button class="btn sm" data-act="add">Add</button>
      </div>
    </div>
  </template>

  <template id="tplLineupRow">
    <div class="item" tabindex="0">
      <div class="title"></div>
      <div style="display:flex;gap:6px">
        <button class="btn sm" data-act="up">‚ñ≤</button>
        <button class="btn sm" data-act="down">‚ñº</button>
        <button class="btn sm danger" data-act="remove">Remove</button>
      </div>
    </div>
  </template>

  <script>
    // --- Supabase Configuration ---
    // IMPORTANT: Replace with your actual Supabase URL and anon key
    const SUPABASE_URL = 'https://lobgzazuzaostqzwdohn.supabase.co'; // e.g., 'https://abcde12345.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvYmd6YXp1emFvc3Rxendkb2huIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMTg1NjMsImV4cCI6MjA3NTc5NDU2M30.tYxUwa_zQ-QAr8mW5Yr2DKoiEQWIqVDqrpqx_7MOzFc'; // e.g., 'eyJ...'

    // Initialize the Supabase client using window.supabase for UMD build
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // -----------------------------

    // ---------- Utilities
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    // uid() is now mostly for fallback or if we need a client-side temporary ID
    const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36); 

    // Local YYYY-MM-DD (no UTC conversion)
    const ymdLocal = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    // Local YYYY-MM for <input type="month">
    const ymLocal = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    };
    
    // Function to format date for display (e.g., "Oct 12, 2025")
    const fmtDate = dStr => new Date(dStr+"T00:00:00").toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});


    // --- Local Cache for faster access and fewer Supabase calls ---
    const localCache = {
        leaders: [],
        songs: [],
        schedules: []
    };

    async function fetchData(table) {
        const { data, error } = await supabase.from(table).select('*');
        if (error) {
            console.error(`Error fetching ${table}:`, error.message);
            return [];
        }
        localCache[table] = data; // Update local cache
        return data;
    }
    // -------------------------------------------------------------

    // ---------- Tabs
    async function goTab(name){
      $$('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name)); 
      $$('main>section').forEach(s=>s.hidden=true);
      $('#tab-'+name).hidden=false;

      // Reload data for relevant tabs
      if(name==='schedules') {
        await Promise.all([fetchData('leaders'), fetchData('songs'), fetchData('schedules')]);
        renderSchedules();
      }
      if(name==='leaders') {
        await fetchData('leaders');
        renderLeaders();
      }
      if(name==='songs'){ 
        await fetchData('songs');
        renderSongs(); 
        renderSongCatalog(); 
      }
      if(name==='new'){ 
        await Promise.all([fetchData('leaders'), fetchData('songs')]); // Ensure leaders and songs are fresh
        preloadCreate(); 
        renderSongCatalog(); 
        renderLineup(); 
      }
    }

    // ---------- Leaders
    let editingLeaderId = null;
    async function renderLeaders(){
      const list = $('#leaderList'); list.innerHTML='';
      const leaders = localCache.leaders.sort((a,b)=>a.name.localeCompare(b.name));
      if(!leaders.length){ list.innerHTML = '<div class="empty">No leaders yet.</div>'; }

      leaders.forEach(l=>{
        const row = document.createElement('div'); row.className='list-item';
        // Profile photo for leaders list view (bigger size)
        const img = l.avatar_url ? `<img class="leader-avatar" src="${l.avatar_url}" alt="${l.name}" style="width:32px;height:32px;">` : ''; 
        row.innerHTML = `
          <div style="display:flex;align-items:center">
            ${img}
            <b>${l.name}</b>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn sm" onclick="editLeader('${l.id}')">Edit</button>
            <button class="btn sm danger" onclick="deleteLeader('${l.id}')">Delete</button>
          </div>`;
        list.appendChild(row);
      });

      // refresh filters + create dropdown
      const lf = $('#leaderFilter');
      lf.innerHTML = '<option value="">All</option>' + leaders.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');
      const sel = $('#schLeader');
      sel.innerHTML = leaders.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');
    }


    async function saveLeader(){
      const name = $('#leaderName').value.trim();
      const photoFile = $('#leaderPhoto').files?.[0] || null;
      const msg = $('#leaderFormMsg');

      if(!name){ msg.textContent='Name is required'; return }

      try {
        let avatar_url = null;
        let currentLeader = null;

        if (editingLeaderId) {
            currentLeader = localCache.leaders.find(l => l.id === editingLeaderId);
        }

        // Handle photo upload/update/removal
        if (photoFile) {
            avatar_url = await uploadLeaderPhoto(photoFile, editingLeaderId || uid()); // use uid as temp id if new leader
        } else if (currentLeader && !$('#leaderPhoto').value && $('#leaderPreview').style.display === 'none') {
            // If there was an existing photo and user explicitly removed it (via clearLeaderPhoto)
            avatar_url = null; 
            if (currentLeader.avatar_url) {
                // Also delete from storage if it exists
                const oldPath = currentLeader.avatar_url.split('/public/leader-photos/')[1];
                if (oldPath) await supabase.storage.from('leader-photos').remove([oldPath]);
            }
        } else if (currentLeader && currentLeader.avatar_url && !photoFile && $('#leaderPreview').style.display !== 'none') {
            // Keep existing photo if no new one was uploaded and not explicitly removed
            avatar_url = currentLeader.avatar_url;
        }

        if(editingLeaderId){
          const payload = { name, avatar_url }; // avatar_url could be new, old, or null

          const { error } = await supabase.from('leaders')
            .update(payload)
            .eq('id', editingLeaderId);
          if (error) throw error;

          msg.textContent='Updated ‚úî';
        } else {
          // If adding new: insert first (to get the id), then update avatar_url if photo was uploaded
          const { data: ins, error: insErr } = await supabase
            .from('leaders')
            .insert({ name, avatar_url: avatar_url }) // Insert with avatar_url initially if already uploaded
            .select()
            .single();
          if (insErr) throw insErr;

          msg.textContent='Added ‚úî';
        }

        // Reset form + refresh
        resetLeaderForm(); // This will also clear photo preview/input
        await fetchData('leaders');
        renderLeaders();
        renderSchedules(); // update schedules view if needed
      } catch (err){
        console.error('saveLeader error:', err);
        msg.textContent = `Error: ${err?.message || err.toString()}`;
      }
    }

    function editLeader(id){
      const l = localCache.leaders.find(x=>x.id===id); 
      if(!l) return; 
      editingLeaderId=id; 
      $('#leaderName').value=l.name; 
      $('#leaderFormMsg').textContent='Editing‚Ä¶';

      // Show current avatar in the preview (if any)
      const img = $('#leaderPreview');
      if (l.avatar_url) {
        img.src = l.avatar_url;
        img.style.display = 'inline-block';
      } else {
        img.src = '';
        img.style.display = 'none';
      }
      // Clear file input so we don't upload unless user picks a new one
      $('#leaderPhoto').value = '';
    }


// Preview photo when user picks a file
$('#leaderPhoto').addEventListener('change', (e) => {
  const f = e.target.files?.[0];
  const img = $('#leaderPreview');
  if (f) {
    const url = URL.createObjectURL(f);
    img.src = url;
    img.style.display = 'inline-block';
  } else {
    img.src = '';
    img.style.display = 'none';
  }
});

function clearLeaderPhoto(){
  const inp = $('#leaderPhoto');
  const img = $('#leaderPreview');
  inp.value = ''; // Clear the file input
  img.src = ''; // Clear the preview image source
  img.style.display = 'none'; // Hide the preview image
  // For an existing leader being edited, this will signal that avatar_url should be set to null
  // when saveLeader is called.
  $('#leaderFormMsg').textContent = 'Photo cleared. Save to apply change.';
}

// Upload to storage and return public URL
async function uploadLeaderPhoto(file, leaderId){
  if (!file) return null;
  const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
  const path = `leaders/${leaderId}-${Date.now()}.${ext}`; // Use leaderId for folder or filename part
  
  // Before uploading new photo, try to remove old one if exists for this leader
  // This is a simplified approach. A more robust solution might track old file paths in DB.
  // For now, we assume if a new photo is uploaded, any old one is superseded.
  // This requires a RLS policy for 'leader-photos' bucket to allow delete.
  const { data: list, error: listErr } = await supabase.storage.from('leader-photos').list('leaders/', { search: `${leaderId}-` });
  if (listErr) console.warn('Could not list old leader photos:', listErr.message);
  else {
      for (const oldFile of list) {
          if (oldFile.name.startsWith(`${leaderId}-`)) {
              await supabase.storage.from('leader-photos').remove([`leaders/${oldFile.name}`]);
          }
      }
  }


  const { error: upErr } = await supabase
    .storage
    .from('leader-photos')
    .upload(path, file, { upsert: true, contentType: file.type });
  if (upErr) throw upErr;

  const { data } = supabase
    .storage
    .from('leader-photos')
    .getPublicUrl(path);

  return data?.publicUrl || null;
}

    async function deleteLeader(id){
      if(!confirm('Delete this leader? This will also remove the leader from any assigned schedules and their profile photo.')) return;
      
      try {
        // Find leader to get avatar_url for storage deletion
        const leaderToDelete = localCache.leaders.find(l => l.id === id);
        if (leaderToDelete && leaderToDelete.avatar_url) {
            const path = leaderToDelete.avatar_url.split('/public/leader-photos/')[1];
            if (path) {
                const { error: storageError } = await supabase.storage.from('leader-photos').remove([path]);
                if (storageError) console.error('Error deleting leader photo from storage:', storageError.message);
            }
        }

        const { error } = await supabase.from('leaders').delete().eq('id', id);
        if (error) throw error;

        await fetchData('leaders'); 
        await fetchData('schedules'); 
        renderLeaders(); 
        renderSchedules();
      } catch (err) {
          console.error('Error deleting leader:', err);
          alert('Failed to delete leader: ' + err.message);
      }
    }
    function resetLeaderForm(){ 
      editingLeaderId=null; 
      $('#leaderName').value=''; 
      $('#leaderFormMsg').textContent=''; 
      clearLeaderPhoto(); // Clear photo on reset
    }

    // ---------- Songs
    let editingSongId = null;
    async function renderSongs(){
      const songs = localCache.songs.sort((a,b)=>a.title.localeCompare(b.title));
      const list = $('#songList'); list.innerHTML='';
      if(!songs.length){ list.innerHTML = '<div class="empty">No songs yet. Add some on the left.</div>'; return }
      songs.forEach(s=>{
        const row = document.createElement('div'); row.className='list-item';
        const meta = [s.key?`Key ${s.key}`:null, s.notes||null].filter(Boolean).join(' ‚Ä¢ ');
        row.innerHTML = `<div><b>${s.title}</b> ${meta?`<span class=muted>‚Äî ${meta}</span>`:''}</div>
          <div style="display:flex;gap:6px">
            <button class="btn sm" onclick="editSong('${s.id}')">Edit</button>
            <button class="btn sm danger" onclick="deleteSong('${s.id}')">Delete</button>
          </div>`;
        list.appendChild(row);
      })
    }
    async function saveSong(){
      const title = $('#songTitle').value.trim();
      const key = $('#songKey').value.trim();
      const notes = $('#songNotes').value.trim();
      if(!title){ $('#songFormMsg').textContent='Title is required'; return }
      
      const payload = { title, key, notes };

      if(editingSongId){
        const { error } = await supabase.from('songs')
            .update(payload)
            .eq('id', editingSongId);
        if (error) { console.error('Error updating song:', error); $('#songFormMsg').textContent=`Error: ${error.message}`; return; }
        $('#songFormMsg').textContent='Updated ‚úî';
      } else {
        const { error } = await supabase.from('songs')
            .insert(payload);
        if (error) { console.error('Error adding song:', error); $('#songFormMsg').textContent=`Error: ${error.message}`; return; }
        $('#songFormMsg').textContent='Added ‚úî';
      }
      editingSongId=null; resetSongForm(false); 
      await fetchData('songs'); // Refresh local cache
      renderSongs(); 
      renderSongCatalog();
      renderSchedules(); // Schedules might need to display updated song titles/details
    }
    function editSong(id){
      const s = localCache.songs.find(x=>x.id===id); if(!s) return; editingSongId=id;
      $('#songTitle').value=s.title; $('#songKey').value=s.key||''; $('#songNotes').value=s.notes||''; $('#songFormMsg').textContent='Editing‚Ä¶';
    }
    async function deleteSong(id){
      if(!confirm('Delete this song? It will be removed from all schedules that use it.')) return;
      const { error } = await supabase.from('songs').delete().eq('id', id);
      if (error) { console.error('Error deleting song:', error); return; }
      await fetchData('songs'); // Refresh local cache
      // No need to fetch schedules as they'll just filter out the deleted song ID
      renderSongs(); 
      renderSongCatalog();
      renderSchedules();
    }
    function resetSongForm(clearMsg=true){
      editingSongId=null; $('#songTitle').value=''; $('#songKey').value=''; $('#songNotes').value=''; if(clearMsg) $('#songFormMsg').textContent='';
    }

    async function seedDemoSongs(){
      const demoSongs = [
        { title: 'Way Maker', key: 'G', notes: '' },
        { title: 'Goodness of God', key: 'D', notes: '' },
        { title: '10,000 Reasons', key: 'C', notes: 'Bless the Lord O My Soul' },
        { title: 'What a Beautiful Name', key: 'D', notes: 'Hillsong Worship' },
        { title: 'Build My Life', key: 'A', notes: '' },
        { title: 'Oceans', key: 'Eb', notes: 'Where Feet May Fail' },
        { title: 'Living Hope', key: 'B', notes: '' },
        { title: 'How Great Is Your Love', key: 'G', notes: 'Chris Tomlin' },
        { title: 'Here I Am to Worship', key: 'E', notes: '' },
        { title: 'Great Are You Lord', key: 'Bb', notes: '' }
      ];
      
      const existingTitles = new Set(localCache.songs.map(s => s.title.toLowerCase()));
      const songsToAdd = demoSongs.filter(s => !existingTitles.has(s.title.toLowerCase()));

      if (songsToAdd.length > 0) {
        const { error } = await supabase.from('songs').insert(songsToAdd);
        if (error) {
          console.error('Error seeding demo songs:', error);
          alert('Failed to seed demo songs: ' + error.message);
        } else {
          await fetchData('songs');
          renderSongs();
          renderSongCatalog();
          alert('Demo songs added!');
        }
      } else {
        alert('All demo songs already exist!');
      }
    }

    // ---------- Create Schedule (lineup)
    let lineup = []; // array of songIds (UUIDs from Supabase)
    let editingScheduleId = null;

    async function preloadCreate(date = null, service = null){
      // Set defaults
      if(date) $('#schDate').value = date;
      else if(!$('#schDate').value){
        const today = new Date();
        $('#schDate').value = ymdLocal(today); // Use ymdLocal
      }

      if(service) $('#schService').value = service;
      else if(!$('#schService').value){
        $('#schService').value = 'Morning';
      }

      const leaders = localCache.leaders;
      if(leaders.length){
          // Ensure the currently selected leader is valid, or default to the first
          if (!$('#schLeader').value || !leaders.some(l => l.id === $('#schLeader').value)) {
              $('#schLeader').value = leaders[0].id;
          }
      } else {
          $('#schLeader').innerHTML = '<option value="">No leaders available</option>';
          $('#schLeader').value = '';
      }
      
      if (!editingScheduleId) { // Only clear these if starting a brand new schedule
        $('#schNotes').value = ''; 
        lineup = []; 
      }
      $('#saveMsg').textContent=''; 
      renderLineup(); 
    }

    function renderSongCatalog(){
      const catalog = $('#songCatalog'); catalog.innerHTML='';
      const q = ($('#songSearch').value||'').toLowerCase();
      const q2 = ($('#songSearch2')?.value||'').toLowerCase();
      const term = q || q2;
      const songs = localCache.songs
        .filter(s=>!term || s.title.toLowerCase().includes(term) || (s.notes||'').toLowerCase().includes(term))
        .sort((a,b)=>a.title.localeCompare(b.title));
      if(!songs.length){ catalog.innerHTML='<div class="empty">No songs match your search.</div>'; return }
      const tpl = $('#tplSongRow');
      songs.forEach(s=>{
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.title').textContent = s.title;
        node.querySelector('.meta').textContent = [s.key?`Key ${s.key}`:null, s.notes||null].filter(Boolean).join(' ‚Ä¢ ');
        node.querySelector('[data-act="add"]').onclick = ()=> addToLineup(s.id);
        catalog.appendChild(node);
      })
    }

    function renderLineup(){
      const box = $('#lineup'); box.innerHTML='';
      if(!lineup.length){ box.innerHTML='<div class="empty">No songs yet. Select from the left and click <b>Add</b>.</div>'; return }
      const tpl = $('#tplLineupRow');
      lineup.forEach((songId,i)=>{
        const s = localCache.songs.find(x=>x.id===songId); 
        if(!s) { 
          // If a song in the lineup no longer exists (e.g., was deleted), remove it
          lineup.splice(i, 1);
          // Recursively call renderLineup to ensure correct indexing and re-rendering
          // This might be inefficient if many songs are missing, but rare.
          renderLineup(); 
          return;
        }
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.dataset.index = i;
        node.querySelector('.title').textContent = `${i+1}. ${s.title}`;
        node.querySelector('[data-act="up"]').onclick = ()=> moveLine(i,-1);
        node.querySelector('[data-act="down"]').onclick = ()=> moveLine(i,1);
        node.querySelector('[data-act="remove"]').onclick = ()=> removeLine(i);
        node.onkeydown = (e)=>{
          if(e.key==='ArrowUp'){ moveLine(i,-1); e.preventDefault(); }
          if(e.key==='ArrowDown'){ moveLine(i,1); e.preventDefault(); }
        }
        box.appendChild(node);
      })
    }
    function addToLineup(songId){ 
      if (!lineup.includes(songId)) { 
        lineup.push(songId); 
        renderLineup(); 
      }
    }
    function moveLine(i,dir){ 
      const j=i+dir; 
      if(j<0||j>=lineup.length) return; 
      [lineup[i],lineup[j]]=[lineup[j],lineup[i]]; 
      renderLineup(); 
      const movedElement = $(`#lineup > [data-index="${j}"]`);
      if (movedElement) movedElement.focus();
    }
    function removeLine(i){ 
      lineup.splice(i,1); 
      renderLineup(); 
    }
    function clearLineup(){ lineup=[]; renderLineup(); }

    $('#saveScheduleBtn').addEventListener('click', async ()=>{
      const date = $('#schDate').value; 
      const service = $('#schService').value; 
      const leader_id = $('#schLeader').value; 
      const notes = $('#schNotes').value.trim();
      
      if(!date){ return $('#saveMsg').innerHTML='<span class=error>Date is required</span>' }
      if(!leader_id){ return $('#saveMsg').innerHTML='<span class=error>Select a leader</span>' }
      
      const payload = { date, service, leader_id, notes, song_ids: [...lineup] };

      let result;
      if(editingScheduleId){ 
        result = await supabase.from('schedules')
            .update(payload)
            .eq('id', editingScheduleId);
        if (!result.error) $('#saveMsg').innerHTML = '<span class=success>Updated ‚úî</span>';
      } else { 
        result = await supabase.from('schedules')
            .insert(payload);
        if (!result.error) $('#saveMsg').innerHTML = '<span class=success>Added ‚úî</span>';
      }
      
      if (result.error) {
          console.error('Error saving schedule:', result.error);
          $('#saveMsg').innerHTML = `<span class=error>Error: ${result.error.message}</span>`;
          return;
      }
      
      await fetchData('schedules'); // Refresh local cache
      renderSchedules();
      goTab('schedules'); // Go back to the schedules list after saving
    });


    // NEW FUNCTIONALITY: Find all Sundays in a given month
   function getSundaysInMonth(year, month /* 0-based */) {
  const sundays = [];
  const d = new Date(year, month, 1); // local

  // find first Sunday
  while (d.getDay() !== 0) d.setDate(d.getDate() + 1);

  // collect all Sundays in the month
  while (d.getMonth() === month) {
    sundays.push(ymdLocal(d));  // <-- stay in local date
    d.setDate(d.getDate() + 7);
  }
  return sundays;
}



    // ---------- List schedules (MODIFIED)
    async function renderSchedules(){
      const listContainer = $('#scheduleList'); listContainer.innerHTML='';
      const leaderMap = Object.fromEntries(localCache.leaders.map(l=>[l.id,l.name]));
      
      const currentMonthFilter = $('#monthFilter').value;
      const [year, monthIndex] = currentMonthFilter ? 
                                 currentMonthFilter.split('-').map(Number) : 
                                 [new Date().getFullYear(), new Date().getMonth() + 1]; 
      
      const sundays = getSundaysInMonth(year, monthIndex - 1); 

      const svcFilter = $('#serviceFilter').value; 
      const leaderFilter = $('#leaderFilter').value;

      if (!sundays.length) {
          listContainer.innerHTML = '<div class="empty">No Sundays found for the selected month.</div>';
          return;
      }

      sundays.forEach(sundayDate => {
          const morningSchedule = localCache.schedules.find(s => s.date === sundayDate && s.service === 'Morning');
          const eveningSchedule = localCache.schedules.find(s => s.date === sundayDate && s.service === 'Evening');

          // Apply leader filter to check if either service matches
          const morningLeaderMatch = !leaderFilter || (morningSchedule && morningSchedule.leader_id === leaderFilter);
          const eveningLeaderMatch = !leaderFilter || (eveningSchedule && eveningSchedule.leader_id === leaderFilter);

          // Determine if this Sunday should be displayed based on service and leader filters
          let displayMorning = false;
          let displayEvening = false;

          if (!svcFilter || svcFilter === 'Morning') {
              if ((morningSchedule && morningLeaderMatch) || (!morningSchedule && !leaderFilter)) {
                  displayMorning = true;
              }
          }
          if (!svcFilter || svcFilter === 'Evening') {
              if ((eveningSchedule && eveningLeaderMatch) || (!eveningSchedule && !leaderFilter)) {
                  displayEvening = true;
              }
          }

          // If neither service for this Sunday should be displayed, skip this Sunday
          if (!displayMorning && !displayEvening) return;

          const sundayDiv = document.createElement('div');
          sundayDiv.className = 'sunday-container';
          sundayDiv.innerHTML = `<div class="sunday-header">${fmtDate(sundayDate)} (Sunday)</div>`;

          // Morning Service Row
          if (displayMorning) {
              const morningRow = document.createElement('div');
              morningRow.className = 'service-row';
              if (!morningSchedule) morningRow.classList.add('no-schedule');
              
              const morningLeader = morningSchedule ? localCache.leaders.find(x => x.id === morningSchedule.leader_id) : null;
              const morningLeaderImg = morningLeader?.avatar_url ? `<img class="leader-avatar" src="${morningLeader.avatar_url}" alt="${morningLeader.name}">` : '';

              const morningInfo = morningSchedule
                  ? `<div class="service-details">
                       <div class="leader-info">${morningLeaderImg}<span><b>${leaderMap[morningSchedule.leader_id] || 'Unassigned'}</b></span> <span class="pill-wrapper"><span class="pill">Morning</span></span></div>
                       <span class="muted" style="font-size:13px">${morningSchedule.song_ids.map(id=> localCache.songs.find(x=>x.id===id)?.title).filter(Boolean).join(' ‚Ä¢ ') || '<i>No songs</i>'}</span>
                       ${morningSchedule.notes ? `<span class="muted" style="font-size:12px">üìù ${morningSchedule.notes.replace(/</g,'&lt;')}</span>` : ''}
                     </div>`
                  : `<div class="service-details">
                       <div class="leader-info"><span class="pill-wrapper"><span class="pill">Morning</span></span> <span class="muted"><i>No schedule</i></span></div>
                     </div>`;

              morningRow.innerHTML = `${morningInfo}
                  <div class="service-actions">
                      ${morningSchedule ? `
                          <button class="btn sm" onclick="editSchedule('${morningSchedule.id}')">Edit</button>
                          <button class="btn sm" onclick="duplicateSchedule('${morningSchedule.id}')">Duplicate</button>
                          <button class="btn sm danger" onclick="deleteSchedule('${morningSchedule.id}')">Delete</button>
                      ` : `
                          <button class="btn sm primary" onclick="addSchedule('${sundayDate}', 'Morning')">Add Schedule</button>
                      `}
                  </div>`;
              sundayDiv.appendChild(morningRow);
          }


          // Evening Service Row
          if (displayEvening) {
              const eveningRow = document.createElement('div');
              eveningRow.className = 'service-row';
              if (!eveningSchedule) eveningRow.classList.add('no-schedule');

              const eveningLeader = eveningSchedule ? localCache.leaders.find(x => x.id === eveningSchedule.leader_id) : null;
              const eveningLeaderImg = eveningLeader?.avatar_url ? `<img class="leader-avatar" src="${eveningLeader.avatar_url}" alt="${eveningLeader.name}">` : '';

              const eveningInfo = eveningSchedule
                  ? `<div class="service-details">
                       <div class="leader-info">${eveningLeaderImg}<span><b>${leaderMap[eveningSchedule.leader_id] || 'Unassigned'}</b></span> <span class="pill-wrapper"><span class="pill">Evening</span></span></div>
                       <span class="muted" style="font-size:13px">${eveningSchedule.song_ids.map(id=> localCache.songs.find(x=>x.id===id)?.title).filter(Boolean).join(' ‚Ä¢ ') || '<i>No songs</i>'}</span>
                       ${eveningSchedule.notes ? `<span class="muted" style="font-size:12px">üìù ${eveningSchedule.notes.replace(/</g,'&lt;')}</span>` : ''}
                     </div>`
                  : `<div class="service-details">
                       <div class="leader-info"><span class="pill-wrapper"><span class="pill">Evening</span></span> <span class="muted"><i>No schedule</i></span></div>
                     </div>`;

              eveningRow.innerHTML = `${eveningInfo}
                  <div class="service-actions">
                      ${eveningSchedule ? `
                          <button class="btn sm" onclick="editSchedule('${eveningSchedule.id}')">Edit</button>
                          <button class="btn sm" onclick="duplicateSchedule('${eveningSchedule.id}')">Duplicate</button>
                          <button class="btn sm danger" onclick="deleteSchedule('${eveningSchedule.id}')">Delete</button>
                      ` : `
                          <button class="btn sm primary" onclick="addSchedule('${sundayDate}', 'Evening')">Add Schedule</button>
                      `}
                  </div>`;
              sundayDiv.appendChild(eveningRow);
          }
          
          listContainer.appendChild(sundayDiv);
      });

      if (listContainer.innerHTML === '') {
        listContainer.innerHTML = '<div class="empty">No Sundays or schedules found matching your filters.</div>';
      }
    }

    // New function to initiate adding a schedule
    function addSchedule(date, service) {
        editingScheduleId = null; // Ensure we're creating a new one
        $('#schDate').value = date;
        $('#schService').value = service;
        $('#schNotes').value = ''; // Clear notes for new entry
        lineup = []; // Clear lineup for new entry
        preloadCreate(date, service); // Preload form with date and service
        goTab('new'); // Switch to the create schedule tab
    }


    async function editSchedule(id){
      const s = localCache.schedules.find(x=>x.id===id); if(!s) return;
      editingScheduleId = id;
      $('#schDate').value = s.date;
      $('#schService').value = s.service;
      $('#schLeader').value = s.leader_id; // Note: leader_id from Supabase
      $('#schNotes').value = s.notes||'';
      lineup = [...s.song_ids]; // Note: song_ids from Supabase
      
      await preloadCreate(s.date, s.service); // Preload form (important for leader dropdown refresh)
      goTab('new');
      renderSongCatalog();
      renderLineup();
      $('#saveMsg').textContent='Editing‚Ä¶';
    }
    async function duplicateSchedule(id){
      const s = localCache.schedules.find(x=>x.id===id); if(!s) return;
      editingScheduleId = null; // Important: clear editing ID for duplication
      $('#schDate').value = s.date;
      $('#schService').value = s.service;
      $('#schLeader').value = s.leader_id; // Note: leader_id from Supabase
      $('#schNotes').value = s.notes||'';
      lineup = [...s.song_ids]; // Note: song_ids from Supabase
      
      await preloadCreate(s.date, s.service); // Preload form
      goTab('new');
      renderSongCatalog();
      renderLineup();
      $('#saveMsg').textContent='Duplicating‚Ä¶';
    }
    async function deleteSchedule(id){
      if(confirm('Delete this schedule?')){
        const { error } = await supabase.from('schedules').delete().eq('id', id);
        if (error) { console.error('Error deleting schedule:', error); alert('Failed to delete schedule: ' + error.message); return; }
        await fetchData('schedules'); // Refresh local cache
        renderSchedules();
      }
    }

    // ---------- Filters & today
    $('#monthFilter').addEventListener('input', renderSchedules);
    $('#serviceFilter').addEventListener('input', renderSchedules);
    $('#leaderFilter').addEventListener('input', renderSchedules);
    $('#songSearch').addEventListener('input', renderSongCatalog);

    // ---------- Backup / Restore / Clear (These will still use localStorage as before)
    // IMPORTANT: The "Backup & Restore" functionality in Settings tab is for LOCAL STORAGE.
    // It will NOT backup/restore data from Supabase.
    // If you need Supabase backups, use the Supabase dashboard tools.
    function downloadBackup(){
      const data = { 
        leaders: JSON.parse(localStorage.getItem('leaders') || '[]'), 
        songs: JSON.parse(localStorage.getItem('songs') || '[]'), 
        schedules: JSON.parse(localStorage.getItem('schedules') || '[]'), 
        exportedAt: new Date().toISOString() 
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'worship-scheduler-localStorage-backup.json'; a.click();
      URL.revokeObjectURL(a.href);
      alert('This backup is for data stored in your browser\'s local storage. Supabase data is managed separately.');
    }
    $('#restoreFile').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return; const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(!data || typeof data!=='object') throw new Error('Invalid file structure.');

        // Restore to localStorage (this does NOT affect Supabase)
        if(Array.isArray(data.leaders)) localStorage.setItem('leaders', JSON.stringify(data.leaders)); else console.warn("Backup file missing 'leaders' array or it's invalid.");
        if(Array.isArray(data.songs)) localStorage.setItem('songs', JSON.stringify(data.songs)); else console.warn("Backup file missing 'songs' array or it's invalid.");
        if(Array.isArray(data.schedules)) localStorage.setItem('schedules', JSON.stringify(data.schedules)); else console.warn("Backup file missing 'schedules' array or it's invalid.");
        
        alert('Local storage restore complete. This does not affect Supabase data.');
        // Re-render everything after a successful restore (only impacts if you switch back to localStorage model)
        // For this Supabase version, this won't change the UI data unless you explicitly re-sync to Supabase.
        // For now, we just reload the main schedules view which will fetch from Supabase.
        await fetchData('leaders');
        await fetchData('songs');
        await fetchData('schedules');
        renderLeaders(); renderSongs(); renderSchedules(); renderSongCatalog();
        goTab('schedules');
      }catch(err){
        alert('Local storage restore failed: '+err.message + ' Please ensure you are uploading a valid JSON backup file.');
        console.error("Restore error:", err);
      }
      e.target.value=''; // Clear the file input
    })
    function clearAll(){
      if(confirm('Are you sure you want to clear ALL LOCAL STORAGE data? This will NOT delete data from Supabase.')){
        localStorage.removeItem('leaders');
        localStorage.removeItem('songs');
        localStorage.removeItem('schedules');
        alert('All local storage data cleared. Supabase data remains untouched.');
        // No need to re-render, as UI is driven by Supabase now
      }
    }


    // ---------- Init Tab Navigation
    function initTabNavigation() {
      $$('.tab-btn[data-tab]').forEach(btn => {
        btn.addEventListener('click', () => {
          goTab(btn.dataset.tab);
        });
      });
      
      const todayBtn = $('#todayBtn');
      if (todayBtn) {
        todayBtn.addEventListener('click', () => {
          const today = new Date();
          $('#monthFilter').value = ymLocal(today); // Use ymLocal for the month filter
          goTab('schedules'); 
        });
      }
    }

    // ---------- Init
    (async function init(){
      // Set the initial month filter to the current month
      const today = new Date();
      $('#monthFilter').value = ymLocal(today); // Use ymLocal for initial month filter value

      initTabNavigation();
      
      // Load initial data from Supabase before rendering anything
      await Promise.all([
          fetchData('leaders'), 
          fetchData('songs'), 
          fetchData('schedules')
      ]);

      renderLeaders(); 
      renderSongs(); 
      // renderSchedules will be called by goTab('schedules')

      // If no leaders exist after fetching, try to seed one
      if(localCache.leaders.length === 0){ 
        const { data, error } = await supabase.from('leaders').insert({ name: '(Unassigned)' }).select();
        if (error) {
          console.error('Error seeding initial leader:', error);
        } else {
          localCache.leaders.push(data[0]); // Add to local cache
          renderLeaders(); // Re-render to update dropdowns
        }
      }
      
      goTab('schedules'); // Set default tab to schedules on initial load
    })();
  </script>
</body>
</html>
